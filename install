#!/bin/bash
set -e

# 定义 Python 解释器的绝对路径
# 根据日志，Coze 环境使用的是 /usr/local/bin/python
PYTHON_EXEC="/usr/local/bin/python"

echo "=========================================="
echo "执行优化后的安装脚本 (Target: /usr/local/bin/python)"
echo "=========================================="

# 1. 验证 Python 环境
echo "DEBUG: 检查 Python 解释器..."
if [ -x "$PYTHON_EXEC" ]; then
    echo "找到解释器: $PYTHON_EXEC"
    $PYTHON_EXEC --version
else
    echo "警告: 未找到 $PYTHON_EXEC，回退到 python3"
    PYTHON_EXEC="python3"
fi

# 2. 确认 Playwright 包状态
echo "DEBUG: 检查 playwright 模块..."
if $PYTHON_EXEC -c "import playwright" 2>/dev/null; then
    echo "✓ Playwright 模块已安装"
else
    echo "✗ 未找到 Playwright 模块，尝试补充安装..."
    $PYTHON_EXEC -m pip install playwright==1.57.0
fi

# 3. 安装浏览器 (关键步骤)
echo "DEBUG: 开始安装浏览器..."

# 设置环境变量，确保安装到正确位置
export PLAYWRIGHT_BROWSERS_PATH=0

# 安装系统依赖 (解决 libgdk 等问题)
echo "运行 install-deps..."
$PYTHON_EXEC -m playwright install-deps

# 安装 Chromium
echo "运行 install chromium..."
$PYTHON_EXEC -m playwright install chromium

# 4. 最终验证
echo "DEBUG: 最终验证..."
if $PYTHON_EXEC -c "from playwright.sync_api import sync_playwright; print('Playwright import success')"; then
    echo "SUCCESS: 安装流程完成！"
else
    echo "ERROR: 验证失败，模块仍不可用"
    exit 1
fi
